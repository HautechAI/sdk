# Hautech SDK – Development Guidelines (Project-Specific)

This document captures non-trivial, project-specific knowledge to speed up future development. It assumes an advanced TypeScript/Node developer.

## 1) Build and Configuration

- Toolchain
    - Node: modern LTS (tested with pnpm 10.x; see package.json `packageManager`).
    - TS 5.5, target ES2022, moduleResolution `bundler`.
    - Build via tsup to CommonJS and ESM bundles with type declarations.
- Commands
    - Build: `pnpm build` (runs tsup using tsup.config.ts). Output goes to `dist/` with CJS, ESM, d.ts and sourcemaps.
    - Generate API client and derived code: `pnpm generate`
        - Runs `scripts/generate.sh`, which:
            - Uses Orval to fetch and regenerate OpenAPI client from `${API_URL:-https://api.hautech.ai}/swagger.json` into `src/autogenerated/` (see orval.config.ts for defaults).
            - Generates permissions types from `${API_URL}/v1/permissions/available` into `src/autogenerated/permissions.ts` (scripts/generate-permissions.js).
            - Generates `src/autogenerated/pipeline-methods.ts` based on `src/autogenerated/call/call.ts` (scripts/generate-pipeline-methods.js).
        - Notes and gotchas:
            - The generate scripts require network access to Hautech API. They will overwrite the contents of `src/autogenerated/*`.
            - The pipeline methods generator expects Orval to have already produced `src/autogenerated/call/call.ts`; ensure Orval step completes first (the script already does this in sequence).
- Configuration surface used by the runtime SDK
    - SDK creation (`createSDK`) accepts:
        - `authToken: () => string | Promise<string>` function that supplies a valid JWT (server-issued) for every request.
        - `baseUrl?: string` (default `https://api.hautech.ai`).
        - `baseWsUrl?: string` (default `baseUrl`).
        - `wsConfig?: Parameters<typeof io>[1]` forwarded to socket.io client.
    - JWT caching: `createSDK` caches the last token in-memory and reuses it until its `exp` is in the future; clock skew in CI can affect this. If you rely on near-expiry tokens, prefer shorter test runs or refresh earlier.

## 2) Testing

- Overview
    - Vitest v3 with SWC and tsconfig-paths. Common setup is `vitest.setup.ts` which loads environment variables from `.env` via `dotenv/config`.
    - Unit test config: `vitest.config.ts` includes `src/**/*.spec.ts`, explicitly excludes E2E.
    - E2E test config: `vitest.e2e.config.ts` includes `src/**/*.spec.e2e.ts`, sets higher timeouts and runs tests serially (maxConcurrency = 1, single worker) to avoid race conditions with shared external resources.
- Commands
    - Unit tests only (verified working): `pnpm test:unit`
        - Current suite count at time of writing: 4 files, 117 tests, all passing locally.
    - E2E tests: `pnpm test:e2e`
        - Requires valid Hautech backend access and credentials (see Env section below). Timeouts are 120s per test/hook.
    - Combined (unit + e2e): `pnpm test`
- Environment for E2E
    - `.env` variables read by `src/__test__/test-utils.ts` when constructing the SDK:
        - `APP_ID` – Hautech application ID.
        - `APP_KEY_ID` – Application key ID.
        - `APP_KEY_SECRET` – Private key material (raw, unwrapped; project code formats to PKCS8 internally).
        - `API_CORE_URL` – Optional; overrides API base URL (HTTP) and, if `baseWsUrl` not provided, WebSocket base URL.
    - The generated WS client uses socket.io with `auth` callback passing `{ token }`. E2E tests force websockets transport in `wsConfig` to avoid polling: `transports: ['websocket']`.
    - If you cannot provide a live Hautech environment, run only unit tests; E2E will fail without valid credentials/backing services.
- Adding tests
    - Unit tests: place files under `src/**/__test__/unit/*.spec.ts` or any `src/**/*.spec.ts` that is not suffixed with `.spec.e2e.ts`.
    - E2E tests: place files under `src/**/__test__/e2e/*.spec.e2e.ts` or any `src/**/*.spec.e2e.ts`.
    - Prefer deterministic unit tests by mocking external libs (example: `socket.io-client` and `jose` are mocked in existing specs).
    - For E2E reliability:
        - Use `sdk.ws.onConnect` and `sdk.ws.onError` hooks; ensure you clear timers in both success and error paths.
        - Keep concurrency at 1 (already configured) to avoid interleaved WS messages between tests.
        - Use generous but bounded timeouts; tests here commonly use 15–20s per operation.

## 3) Additional Development Information

- API surface and wrapping
    - `src/sdk/api.ts` assembles grouped API definitions (from Orval) and exposes pipelines and WebSocket client.
    - `wrapApiCallDeep` (see `src/api-utils.ts`) returns the unwrapped Axios data; the SDK types (`DeepWrap`) ensure callers receive response bodies rather than AxiosResponse.
- WebSocket client specifics
    - Implemented in `src/sdk/ws-client.ts`.
    - Lazily creates a single socket via `io(baseWsUrl, { auth(cb) { cb({ token }) } })`.
    - Event API:
        - `onConnect(cb)` – calls cb immediately if already connected, otherwise registers on `connect`.
        - `subscribe<T>(topic, cb)` / `unsubscribe<T>(topic, cb?)` – typed by `WsEventMap`.
        - `subscribeEntityById(entity, id, cb)` / `unsubscribeEntityById(entity, id, cb?)` – also emits `entity:subscribe`/`entity:unsubscribe` messages to the server; event topics are namespaced as `${entity}:${id}`.
        - `onError(cb)`/`offError(cb?)` – wires to `connect_error` and `server_error`.
    - Types for events are centralized in `src/sdk/ws-events.types.ts`. Preview streams (e.g., `operation:preview`) carry a subset of entity fields; by-id channels carry full entities.
- Token generation
    - `createTokenSigner` composes RS256 JWTs and serializes permissions from `MethodsPermissions` (auto-generated) to colon-delimited scopes (e.g., `balances:self:read`).
    - The signer only formats keys; provide raw secret (no PEM headers). The code will wrap and chunk to 64-char lines.
- Code style and linting
    - Prettier 3.x is available; no project-local config is committed—use defaults or your editor’s standard Prettier settings.
    - `lint`/`lint:fix` scripts call Nx across the monorepo: they are intended to run from the workspace root where Nx is configured. Running them in this package alone may not work unless Nx tooling is bootstrapped.
- Releasing and versioning
    - `scripts/up-versions.sh` uses semantic-release to cut a release tag `${PACKAGE_NAME}@${version}` with `--no-ci`. In CI, standard semantic-release configuration (`release.config.cjs`) applies.
    - Conventional Commits are expected for changelog generation.
- Local debugging tips
    - If WS connect seems idle in dev, ensure `transports: ['websocket']` to avoid CORS/polling pitfalls.
    - When testing token refresh logic, note that decode is purely by `exp`; tokens without `exp` will be treated as always expired and thus always refreshed.
    - OpenAPI-generated clients can change shape on API updates; re-run `pnpm generate` after backend changes and re-run unit tests.

## 4) Quick Recipes

- Build SDK locally
    - `pnpm i && pnpm build`
- Run unit tests only (no external deps)
    - `pnpm test:unit`
- Run E2E tests against a real backend
    - Create `.env` with `APP_ID`, `APP_KEY_ID`, `APP_KEY_SECRET`, and optionally `API_CORE_URL`.
    - `pnpm test:e2e`
- Regenerate client after backend changes
    - `pnpm generate` (optional first arg to `scripts/generate.sh` overrides API URL, e.g. `./scripts/generate.sh https://staging.hautech.ai`).
