import { useApi, wrapApiCallNullable } from '../../api-utils';
import { SDK } from '../../types';
import axios from 'axios';
import { ImageEntity } from '../../autogenerated/schemas';
import { getImages } from '../../autogenerated/images/images';

export const useImagesApi = () => {
    const hautechApi = getImages();

    return useApi({
        startUpload: hautechApi.imagesControllerStartUploadV1,
        finalizeUpload: hautechApi.imagesControllerFinalizeUploadV1,
        get: wrapApiCallNullable(hautechApi.imagesControllerGetImageV1),
        getUrls: hautechApi.imagesControllerGetUrlsV1,
        getRepresentation: hautechApi.imagesControllerGetRepresentationV1,
        createFromFile: async function (
            this: any,
            file:
                | string
                | Blob
                | {
                      stream: NodeJS.ReadableStream;
                      filename: string;
                      contentType: string;
                  },
        ): Promise<ImageEntity> {
            const sdk: SDK = this;
            const uploadResult = await sdk.images.startUpload();

            const isBrowser = typeof window !== 'undefined';

            let formData: any;

            if (isBrowser) {
                formData = new FormData();
            } else {
                const FormDataNode = require('form-data');
                formData = new FormDataNode();
            }

            if (typeof file === 'string') {
                if (isBrowser) throw new Error('Cannot use file path in browser');
                const fs = require('fs');

                formData.append('file', fs.createReadStream(file));
            } else if (isBrowser && file instanceof Blob) {
                formData.append('file', file);
            } else if (typeof file === 'object' && 'filename' in file) {
                formData.append('file', file.stream, {
                    filename: file.filename,
                    contentType: file.contentType,
                });
            } else {
                throw new Error('Unsupported file type');
            }

            const headers = isBrowser ? {} : formData.getHeaders();

            const uploadResponse = await axios.put(uploadResult.uploadUrl, formData, {
                headers,
                maxBodyLength: Infinity,
            });

            const fileToken = uploadResponse.data.fileToken;
            const finalizeResult = await sdk.images.finalizeUpload({
                fileToken: fileToken,
            });

            if (!finalizeResult?.id) {
                throw new Error('Failed to finalize image upload');
            }

            return finalizeResult;
        },
        createFromUrl: async function (this: any, fileUrl: string): Promise<ImageEntity> {
            const sdk: SDK = this;

            const isBrowser = typeof window !== 'undefined' && typeof Blob !== 'undefined';

            if (isBrowser) {
                const response = await axios.get(fileUrl, { responseType: 'blob', timeout: 30000 });
                const blob = new Blob([response.data], { type: response.headers['content-type'] });
                return sdk.images.createFromFile(blob);
            } else {
                const response = await axios.get(fileUrl, { responseType: 'stream', timeout: 30000 });
                return sdk.images.createFromFile({
                    stream: response.data,
                    filename: fileUrl.split('/').pop()!,
                    contentType: response.headers['content-type'] || 'application/octet-stream',
                });
            }
        },
    });
};
