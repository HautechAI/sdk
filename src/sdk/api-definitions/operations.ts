import { useApi, wrapApiCallNullable, wrapCustomMethod } from '../../api-utils';
import { SDK } from '../../types';
import { OperationEntity } from '../../autogenerated/schemas';
import { getOperations } from '../../autogenerated/operations/operations';

const waitOperation = wrapCustomMethod(async function <
    O,
    T extends Omit<OperationEntity, 'output'> & { output: O extends unknown ? any : O },
>(this: any, operation: T, timeoutMs = 60000, delay = 3000): Promise<T> {
    const deadline = Date.now() + timeoutMs;
    const sdk: SDK = this;

    const sleep = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));

    const poll = async (id: string) => {
        const op = await sdk.operations.getStatus(id);
        if (!op) throw new Error('Operation not found');
        if (op.status !== 'pending') return op.operation;
        return null;
    };

    while (Date.now() < deadline) {
        const result = await poll(operation.id);
        if (result) return result as T;
        await sleep(delay);
    }

    throw new Error('Operation timed out');
});

const waitOperationById = wrapCustomMethod(async function (
    this: any,
    operationId: string,
    timeoutMs = 60000,
    delay = 3000,
): Promise<OperationEntity> {
    const deadline = Date.now() + timeoutMs;
    const sdk: SDK = this;

    const sleep = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));

    const poll = async (id: string) => {
        const op = await sdk.operations.get(id);
        if (!op) throw new Error('Operation not found');
        if (op.status !== 'pending') return op;
        return null;
    };

    while (Date.now() < deadline) {
        const result = await poll(operationId);
        if (result) return result;
        await sleep(delay);
    }

    throw new Error('Operation timed out');
});

export const useOperationsApi = () => {
    const hautechApi = getOperations();

    return useApi({
        run: {
            animate: {
                kling_1_6_pro: {
                    v1: hautechApi.operationsControllerRunAnimateKling16ProV1V1,
                },
                kling_2_1: {
                    v1: hautechApi.operationsControllerRunAnimateKling21V1V1,
                },
                creatomate: {
                    v1: hautechApi.operationsControllerRunAnimateCreatomateV1V1,
                },
                veo3: {
                    v1: hautechApi.operationsControllerRunVeo3V1V1,
                    fast: {
                        v1: hautechApi.operationsControllerRunVeo3FastV1V1,
                    },
                },
            },
            edit: {
                flux_kontext_dev: {
                    v1: hautechApi.operationsControllerRunEditFluxKontextDevV1V1,
                },
            },
            haute: {
                linda: {
                    v1: hautechApi.operationsControllerRunHauteLindaV1V1,
                },
                naomi: {
                    v1: hautechApi.operationsControllerRunHauteNaomiV1V1,
                    train: hautechApi.operationsControllerRunHauteNaomiTrainV1V1,
                    prepareDataset: hautechApi.operationsControllerRunHauteNaomiPrepareDatasetV1V1,
                },
            },
            ideogram: {
                character: {
                    v1: hautechApi.operationsControllerRunIdeogramCharacterV1V1,
                },
            },
            inpaint: {
                kate: {
                    v1: hautechApi.operationsControllerRunInpaintKateV1V1,
                },
            },
            gpt: {
                v1: hautechApi.operationsControllerRunGptV1V1,
                v2: hautechApi.operationsControllerRunGptV2V1,
                v3: hautechApi.operationsControllerRunGptV3V1,
            },
            math: {
                v1: hautechApi.operationsControllerRunMathV1V1,
            },
            translate: {
                v1: hautechApi.operationsControllerRunTranslateV1V1,
            },
            imagine: {
                kate: {
                    v1: hautechApi.operationsControllerRunImagineKateV1V1,
                },
                flux_1_1_pro_ultra: {
                    v1: hautechApi.operationsControllerRunImagineFlux11ProUltraV1V1,
                },
                luma: {
                    photon: {
                        v1: hautechApi.operationsControllerRunLumaPhotonV1V1,
                    },
                },
                imagen4: {
                    v1: hautechApi.operationsControllerRunImagen4V1V1,
                    fast: {
                        v1: hautechApi.operationsControllerRunImagen4FastV1V1,
                    },
                    standard: {
                        v1: hautechApi.operationsControllerRunImagen4StandardV1V1,
                    },
                    ultra: {
                        v1: hautechApi.operationsControllerRunImagen4UltraV1V1,
                    },
                },
                seedream3: {
                    v1: hautechApi.operationsControllerRunSeedream3V1V1,
                },
                seed: {
                    v1: hautechApi.operationsControllerRunSeedV1V1,
                },
                seedream: {
                    '4_edit': {
                        v1: hautechApi.operationsControllerRunSeedream4EditV1V1,
                    },
                    '4_5_edit': {
                        v1: hautechApi.operationsControllerRunSeedream45EditV1V1,
                    },
                    '4_t2i': {
                        v1: hautechApi.operationsControllerRunSeedream4T2iV1V1,
                    },
                    '4_5_t2i': {
                        v1: hautechApi.operationsControllerRunSeedream45T2iV1V1,
                    },
                },
            },
            upscale: {
                v1: hautechApi.operationsControllerRunUpscaleV1V1,
                topaz: {
                    v1: hautechApi.operationsControllerRunTopazUpscaleV1V1,
                },
            },
            objectDetection: {
                v1: hautechApi.operationsControllerRunObjectDetectionV1V1,
            },
            segmentAnything: {
                embeddings: {
                    v1: hautechApi.operationsControllerRunSegmentAnythingEmbeddingsV1V1,
                },
                mask: {
                    v1: hautechApi.operationsControllerRunSegmentAnythingMaskV1V1,
                },
            },
            poseEstimation: {
                v1: hautechApi.operationsControllerRunPoseEstimationV1V1,
            },
            cut: {
                v1: hautechApi.operationsControllerRunCutV1V1,
            },
            crop: {
                v1: hautechApi.operationsControllerRunCropV1V1,
            },
            noise: {
                v1: hautechApi.operationsControllerRunNoiseV1V1,
            },
            contrast: {
                v1: hautechApi.operationsControllerRunContrastV1V1,
            },
            composite: {
                v1: hautechApi.operationsControllerRunCompositeV1V1,
            },
            images: {
                downscale: {
                    v1: hautechApi.operationsControllerRunImagesDownscaleV1V1,
                },
                rename: {
                    v1: hautechApi.operationsControllerRunImagesRenameV1V1,
                },
            },
            vton: {
                gisele: {
                    v1: hautechApi.operationsControllerRunVtonGiseleV1V1,
                },
            },
            negateImage: {
                v1: hautechApi.operationsControllerRunNegateImageV1V1,
            },
            resize: {
                v1: hautechApi.operationsControllerRunResizeV1V1,
            },
            strings: {
                template: {
                    v1: hautechApi.operationsControllerRunStringsTemplateV1V1,
                },
                switch: {
                    v1: hautechApi.operationsControllerRunStringsSwitchV1V1,
                },
                slice: {
                    v1: hautechApi.operationsControllerRunStringsSliceV1V1,
                },
                length: {
                    v1: hautechApi.operationsControllerRunStringsLengthV1V1,
                },
                parse: {
                    json: {
                        v1: hautechApi.operationsControllerRunStringsParseJsonV1V1,
                    },
                },
            },
            onecompiler: {
                v1: hautechApi.operationsControllerRunOnecompilerV1V1,
            },
            pipelineMap: {
                v1: hautechApi.operationsControllerRunPipelineMapV1V1,
            },
            echo: {
                v1: hautechApi.operationsControllerRunEchoV1V1,
            },
            google: {
                nano_banana: {
                    v1: hautechApi.operationsControllerRunGoogleNanoBananaV1V1,
                },
                nano_banana_pro: {
                    edit: {
                        v1: hautechApi.operationsControllerRunGoogleNanoBananaProEditV1V1,
                    },
                },
            },
            fashn: {
                vton_1_6: {
                    v1: hautechApi.operationsControllerRunFashnVton16V1V1,
                },
            },
            alphabake: {
                vton: {
                    v1: hautechApi.operationsControllerRunAlphabakeVtonV1V1,
                },
            },
            kling: {
                kolors_vton: {
                    v1: hautechApi.operationsControllerRunKlingKolorsVtonV1V1,
                },
                video_2_5_pro: {
                    image_to_video: {
                        v1: hautechApi.operationsControllerRunKlingVideo25ProImageToVideoV1V1,
                    },
                },
            },
            json_to_image: {
                v1: hautechApi.operationsControllerRunJsonToImageV1V1,
            },
            json_to_video: {
                v1: hautechApi.operationsControllerRunJsonToVideoV1V1,
            },
            reve: {
                remix: {
                    v1: hautechApi.operationsControllerRunReveRemixV1V1,
                },
            },
            yolo11x_pose: {
                v1: hautechApi.operationsControllerRunYolo11xPoseV1V1,
            },
            seedance_v1: {
                pro: {
                    v1: hautechApi.operationsControllerRunSeedanceV1ProV1V1,
                },
                fast: {
                    v1: hautechApi.operationsControllerRunSeedanceV1FastV1V1,
                },
                light: {
                    v1: hautechApi.operationsControllerRunSeedanceV1LightV1V1,
                },
            },
            flux: {
                kontext_dev: {
                    prepare_dataset: {
                        v1: hautechApi.operationsControllerRunFluxKontextDevPrepareDatasetV1V1,
                    },
                    train: {
                        v1: hautechApi.operationsControllerRunFluxKontextDevTrainV1V1,
                    },
                    v1: hautechApi.operationsControllerRunFluxKontextDevV1V1,
                },
            },
            clipClassify: {
                v1: hautechApi.operationsControllerRunClipClassifyV1V1,
            },
            workflow: {
                run: {
                    v1: hautechApi.operationsControllerRunWorkflowsRunV1V1,
                },
            },
            veo3_1: {
                v1: hautechApi.operationsControllerRunVeo31V1V1,
                fast: {
                    v1: hautechApi.operationsControllerRunVeo31FastV1V1,
                },
            },
        },
        get: wrapApiCallNullable(hautechApi.operationsControllerGetOperationV1),
        getStatus: wrapApiCallNullable(hautechApi.operationsControllerGetOperationStatusV1),
        getMany: hautechApi.operationsControllerGetOperationsV1,
        list: hautechApi.operationsControllerListOperationsV1,
        updateMetadata: hautechApi.operationsControllerUpdateMetadataV1,
        wait: waitOperation,
        waitById: waitOperationById,
    });
};
