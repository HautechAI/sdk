import axios from 'axios';
import { SDKOptions } from '../../types';
import { ImageEntity, ImagesApi } from '../../autogenerated';
import { useAutogeneratedAPI } from '../../api';

const images = (options: SDKOptions) => {
    const api = useAutogeneratedAPI({ API: ImagesApi, options });
    const createFromFile = async (props: { file: Blob }): Promise<ImageEntity> => {
        const uploadUrl = await api.call({
            run: (methods) => methods.imagesControllerStartUploadV1(),
            transform: (data) => data.uploadUrl,
        });

        const formData = new FormData();
        formData.append('file', props.file);

        const response = await axios.put(uploadUrl, formData, {
            headers: { 'Content-Type': 'multipart/form-data' },
        });
        const fileToken = response.data.fileToken;

        return await api.call({ run: (methods) => methods.imagesControllerFinalizeUploadV1({ fileToken }) });
    };

    return {
        createFromFile,
        createFromUrl: async (props: { url: string }) => {
            const response = await axios.get(props.url, { responseType: 'arraybuffer' });
            const file = new Blob([response.data], { type: response.headers['content-type'] });
            return createFromFile({ file });
        },
        get: async (props: { id: string }): Promise<ImageEntity | undefined> =>
            api.callWithReturningUndefinedOn404({
                run: (methods) => methods.imagesControllerGetImageV1(props.id),
            }),
        getUrls: async (props: { ids: string[] }): Promise<Record<string, string>> =>
            api.call({
                run: (methods) => methods.imagesControllerGetUrlsV1({ ids: props.ids }),
                transform: (data) => data.reduce((acc, { id, url }) => ({ ...acc, [id]: url }), {}),
            }),
    };
};

export default images;
